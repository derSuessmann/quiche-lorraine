---
# tasks file for qsstv

- name: Install system packages for {{ name_version }}
  package:
    name: '{{ required_system_packages }}'
    state: latest
  become: true
  tags: 'prepare'

- include_role: 
    name: get_source
  vars:
    method: 'download_archive'
    pkg_name: '{{ name_version }}'
    source_uri: 'http://users.telenet.be/on4qz/qsstv/downloads/qsstv_{{ this_version }}.tar.gz'
    destination: '{{ download_dir }}/{{ name_version }}'
  tags: 'get_source'

# hack to include version in build dir, because current archive 
# does not contain version
- name: stat foo
  stat: 
    path: '{{ download_dir }}/qsstv'
  register: qsstv_build_stat

- name: Rename build directory
  command: mv '{{ download_dir }}/qsstv' '{{ download_dir }}/{{ name_version }}'
  when: qsstv_build_stat.stat.exists

- name: Remove conflicting system packages for {{ name_version }}
  package:
    name:
    - qsstv
    state: absent
  become: true
  tags: 'cleanup'

- include_role: 
    name: build_install
  vars:
    method: 'qmake'
    pkg_name: '{{ name_version }}'
    source_path: '{{ download_dir }}/{{ name_version }}'
    build_path: '{{ build_dir }}/{{ name_version }}'
    install_path: '{{ stow_dir }}/{{ name_version }}'
    qmake_profile: 'qsstv.pro'
  tags: 'build_install'

- name: Create additional directories for {{ name_version }}
  ansible.builtin.file:
    path: '{{ stow_dir }}/{{ name_version }}/{{ directory }}'
    state: directory
    mode: 'u=rwx,go=rx'
  loop: ['share/applications/', 'share/icons']
  loop_control:
    loop_var: directory
  become: true

- name: Create .desktop file for {{ name_version }}
  template:
    src: desktop.j2
    dest: '{{ stow_dir }}/{{ name_version }}/share/applications/qsstv.desktop'
  become: true

- name: Copy icon for {{ name_version }}
  copy:
    src: '{{ download_dir }}/{{ name_version }}/icons/qsstv.png'
    dest: '{{ stow_dir }}/{{ name_version }}/share/pixmaps/'
    remote_src: yes
  become: true

- name: Stow {{ name_version }}
  command:
    cmd: 'stow -R {{ name_version }}'
    chdir: '{{ stow_dir }}'
  become: true
